if (DollCase) then
    return
end

DollCase = {}

-- Constants
local DOLL_STATUS_OWN = 1
local DOLLS_NUMBER = 250 -- Missing unown

local DOLL_ITEMID_BY_POKEMON_NAME = {
    ["Bulbasaur"] = 12271,
    ["Ivysaur"] = 17820,
    ["Venusaur"] = 17821,
    ["Charmander"] = 17822,
    ["Charmeleon"] = 17823,
    ["Charizard"] = 17824,
    ["Squirtle"] = 17825,
    ["Wartortle"] = 17826,
    ["Blastoise"] = 17827,
    ["Caterpie"] = 17828,
    ["Metapod"] = 17829,
    ["Butterfree"] = 17830,
    ["Weedle"] = 17831,
    ["Kakuna"] = 17832,
    ["Beedrill"] = 17833,
    ["Pidgey"] = 17834,
    ["Pidgeotto"] = 17835,
    ["Pidgeot"] = 12253,
    ["Rattata"] = 17836,
    ["Raticate"] = 17837,
    ["Spearow"] = 17838,
    ["Fearow"] = 17839,
    ["Ekans"] = 17840,
    ["Arbok"] = 17841,
    ["Pikachu"] = 12256,
    ["Raichu"] = 12272,
    ["Sandshrew"] = 17842,
    ["Sandslash"] = 17843,
    ["Nidorana"] = 17844,
    ["Nidorina"] = 17845,
    ["Nidoqueen"] = 17846,
    ["Nidorano"] = 17847,
    ["Nidorino"] = 17848,
    ["Nidoking"] = 17849,
    ["Clefairy"] = 17850,
    ["Clefable"] = 17851,
    ["Vulpix"] = 17852,
    ["Ninetales"] = 17853,
    ["Jigglypuff"] = 12270,
    ["Wigglytuff"] = 17854,
    ["Zubat"] = 17855,
    ["Golbat"] = 17856,
    ["Oddish"] = 17857,
    ["Gloom"] = 17858,
    ["Vileplume"] = 17859,
    ["Paras"] = 17860,
    ["Parasect"] = 17861,
    ["Venonat"] = 17862,
    ["Venomoth"] = 17863,
    ["Diglett"] = 17864,
    ["Dugtrio"] = 17865,
    ["Meowth"] = 17866,
    ["Persian"] = 17867,
    ["Psyduck"] = 12263,
    ["Golduck"] = 17868,
    ["Mankey"] = 17869,
    ["Primeape"] = 17870,
    ["Growlithe"] = 17871,
    ["Arcanine"] = 17872,
    ["Poliwag"] = 17873,
    ["Poliwhirl"] = 17874,
    ["Poliwrath"] = 12255,
    ["Abra"] = 17875,
    ["Kadabra"] = 17876,
    ["Alakazam"] = 17877,
    ["Machop"] = 17878,
    ["Machoke"] = 17879,
    ["Machamp"] = 17880,
    ["Bellsprout"] = 17881,
    ["Weepinbell"] = 17882,
    ["Victreebel"] = 17883,
    ["Tentacool"] = 17884,
    ["Tentacruel"] = 17885,
    ["Geodude"] = 17886,
    ["Graveler"] = 17887,
    ["Golem"] = 17888,
    ["Ponyta"] = 17889,
    ["Rapidash"] = 17890,
    ["Slowpoke"] = 17891,
    ["Slowbro"] = 12266,
    ["Magnemite"] = 17892,
    ["Magneton"] = 17893,
    ["Farfetchd"] = 17894,
    ["Doduo"] = 17895,
    ["Dodrio"] = 17896,
    ["Seel"] = 12257,
    ["Dewgong"] = 17897,
    ["Grimer"] = 17898,
    ["Muk"] = 17899,
    ["Shellder"] = 17900,
    ["Cloyster"] = 17901,
    ["Gastly"] = 17902,
    ["Haunter"] = 17903,
    ["Gengar"] = 17904,
    ["Onix"] = 17905,
    ["Drowzee"] = 17906,
    ["Hypno"] = 17907,
    ["Krabby"] = 17908,
    ["Kingler"] = 17909,
    ["Voltorb"] = 17910,
    ["Electrode"] = 17911,
    ["Exeggcute"] = 17912,
    ["Exeggutor"] = 17913,
    ["Cubone"] = 12269,
    ["Marowak"] = 17914,
    ["Hitmonlee"] = 17915,
    ["Hitmonchan"] = 17916,
    ["Lickitung"] = 17917,
    ["Koffing"] = 17918,
    ["Weezing"] = 17919,
    ["Rhyhorn"] = 17920,
    ["Rhydon"] = 17921,
    ["Chansey"] = 12268,
    ["Tangela"] = 17922,
    ["Kangaskhan"] = 17923,
    ["Horsea"] = 17924,
    ["Seadra"] = 17925,
    ["Goldeen"] = 17926,
    ["Seaking"] = 17927,
    ["Staryu"] = 17928,
    ["Starmie"] = 17929,
    ["Mr. Mime"] = 17930,
    ["Scyther"] = 17931,
    ["Jynx"] = 17932,
    ["Electabuzz"] = 17933,
    ["Magmar"] = 17934,
    ["Pinsir"] = 17935,
    ["Tauros"] = 17936,
    ["Magikarp"] = 17937,
    ["Gyarados"] = 17938,
    ["Lapras"] = 12258,
    ["Ditto"] = 17939,
    ["Eevee"] = 17940,
    ["Vaporeon"] = 17941,
    ["Jolteon"] = 17942,
    ["Flareon"] = 17943,
    ["Porygon"] = 17944,
    ["Omanyte"] = 12267,
    ["Omastar"] = 17945,
    ["Kabuto"] = 12265,
    ["Kabutops"] = 17946,
    ["Aerodactyl"] = 17947,
    ["Snorlax"] = 17948,
    ["Articuno"] = 12260,
    ["Zapdos"] = 12261,
    ["Moltres"] = 12262,
    ["Dratini"] = 17949,
    ["Dragonair"] = 17950,
    ["Dragonite"] = 17951,
    ["Mewtwo"] = 12264,
    ["Mew"] = 12254,
    ["Chikorita"] = 17952,
    ["Bayleef"] = 17953,
    ["Meganium"] = 17954,
    ["Cyndaquil"] = 17955,
    ["Quilava"] = 17956,
    ["Typhlosion"] = 17957,
    ["Totodile"] = 17958,
    ["Croconaw"] = 17959,
    ["Feraligatr"] = 17960,
    ["Sentret"] = 17961,
    ["Furret"] = 17962,
    ["Hoothoot"] = 17963,
    ["Noctowl"] = 17964,
    ["Ledyba"] = 17965,
    ["Ledian"] = 17966,
    ["Spinarak"] = 17967,
    ["Ariados"] = 17968,
    ["Crobat"] = 17969,
    ["Chinchou"] = 17970,
    ["Lanturn"] = 17971,
    ["Pichu"] = 17972,
    ["Cleffa"] = 17973,
    ["Igglybuff"] = 17974,
    ["Togepi"] = 17975,
    ["Togetic"] = 17976,
    ["Natu"] = 17977,
    ["Xatu"] = 17978,
    ["Mareep"] = 17979,
    ["Flaaffy"] = 17980,
    ["Ampharos"] = 17981,
    ["Bellossom"] = 17982,
    ["Marill"] = 17983,
    ["Azumarill"] = 17984,
    ["Sudowoodo"] = 17985,
    ["Politoed"] = 17986,
    ["Hoppip"] = 17987,
    ["Skiploom"] = 17988,
    ["Jumpluff"] = 17989,
    ["Aipom"] = 17990,
    ["Sunkern"] = 17991,
    ["Sunflora"] = 17992,
    ["Yanma"] = 17993,
    ["Wooper"] = 17994,
    ["Quagsire"] = 17995,
    ["Espeon"] = 17996,
    ["Umbreon"] = 17997,
    ["Murkrow"] = 17998,
    ["Slowking"] = 17999,
    ["Misdreavus"] = 18000,
    ["Wobbuffet"] = 18001,
    ["Girafarig"] = 18002,
    ["Pineco"] = 18003,
    ["Forretress"] = 18004,
    ["Dunsparce"] = 18005,
    ["Gligar"] = 18006,
    ["Steelix"] = 18007,
    ["Snubbull"] = 18008,
    ["Granbull"] = 18009,
    ["Qwilfish"] = 18010,
    ["Scizor"] = 18011,
    ["Shuckle"] = 18012,
    ["Heracross"] = 18013,
    ["Sneasel"] = 18014,
    ["Teddiursa"] = 18015,
    ["Ursaring"] = 18016,
    ["Slugma"] = 18017,
    ["Magcargo"] = 18018,
    ["Swinub"] = 18019,
    ["Piloswine"] = 18020,
    ["Corsola"] = 18021,
    ["Remoraid"] = 18022,
    ["Octillery"] = 18023,
    ["Delibird"] = 18024,
    ["Mantine"] = 18025,
    ["Skarmory"] = 18026,
    ["Houndour"] = 18027,
    ["Houndoom"] = 18028,
    ["Kingdra"] = 18029,
    ["Phanpy"] = 18030,
    ["Donphan"] = 18031,
    ["Porygon2"] = 18032,
    ["Stantler"] = 18033,
    ["Smeargle"] = 18034,
    ["Tyrogue"] = 18035,
    ["Hitmontop"] = 18036,
    ["Smoochum"] = 18037,
    ["Elekid"] = 18038,
    ["Magby"] = 18039,
    ["Miltank"] = 18040,
    ["Blissey"] = 18041,
    ["Raikou"] = 18042,
    ["Entei"] = 18043,
    ["Suicune"] = 18044,
    ["Larvitar"] = 18045,
    ["Pupitar"] = 18046,
    ["Tyranitar"] = 18047,
    ["Lugia"] = 12259,
    ["Ho-Oh"] = 18048,
    ["Celebi"] = 18049,
} -- 1 missing?

local POKEMON_NAME_BY_DOLL_ITEMID = table.inverse(DOLL_ITEMID_BY_POKEMON_NAME)

local DOLL_STORAGE_BY_POKEMON_NAME = {
    ["Bulbasaur"] = 25000,
    ["Ivysaur"] = 25001,
    ["Venusaur"] = 25002,
    ["Charmander"] = 25003,
    ["Charmeleon"] = 25004,
    ["Charizard"] = 25005,
    ["Squirtle"] = 25006,
    ["Wartortle"] = 25007,
    ["Blastoise"] = 25008,
    ["Caterpie"] = 25009,
    ["Metapod"] = 25010,
    ["Butterfree"] = 25011,
    ["Weedle"] = 25012,
    ["Kakuna"] = 25013,
    ["Beedrill"] = 25014,
    ["Pidgey"] = 25015,
    ["Pidgeotto"] = 25016,
    ["Pidgeot"] = 25017,
    ["Rattata"] = 25018,
    ["Raticate"] = 25019,
    ["Spearow"] = 25020,
    ["Fearow"] = 25021,
    ["Ekans"] = 25022,
    ["Arbok"] = 25023,
    ["Pikachu"] = 25024,
    ["Raichu"] = 25025,
    ["Sandshrew"] = 25026,
    ["Sandslash"] = 25027,
    ["Nidorana"] = 25028,
    ["Nidorina"] = 25029,
    ["Nidoqueen"] = 25030,
    ["Nidorano"] = 25031,
    ["Nidorino"] = 25032,
    ["Nidoking"] = 25033,
    ["Clefairy"] = 25034,
    ["Clefable"] = 25035,
    ["Vulpix"] = 25036,
    ["Ninetales"] = 25037,
    ["Jigglypuff"] = 25038,
    ["Wigglytuff"] = 25039,
    ["Zubat"] = 25040,
    ["Golbat"] = 25041,
    ["Oddish"] = 25042,
    ["Gloom"] = 25043,
    ["Vileplume"] = 25044,
    ["Paras"] = 25045,
    ["Parasect"] = 25046,
    ["Venonat"] = 25047,
    ["Venomoth"] = 25048,
    ["Diglett"] = 25049,
    ["Dugtrio"] = 25050,
    ["Meowth"] = 25051,
    ["Persian"] = 25052,
    ["Psyduck"] = 25053,
    ["Golduck"] = 25054,
    ["Mankey"] = 25055,
    ["Primeape"] = 25056,
    ["Growlithe"] = 25057,
    ["Arcanine"] = 25058,
    ["Poliwag"] = 25059,
    ["Poliwhirl"] = 25060,
    ["Poliwrath"] = 25061,
    ["Abra"] = 25062,
    ["Kadabra"] = 25063,
    ["Alakazam"] = 25064,
    ["Machop"] = 25065,
    ["Machoke"] = 25066,
    ["Machamp"] = 25067,
    ["Bellsprout"] = 25068,
    ["Weepinbell"] = 25069,
    ["Victreebel"] = 25070,
    ["Tentacool"] = 25071,
    ["Tentacruel"] = 25072,
    ["Geodude"] = 25073,
    ["Graveler"] = 25074,
    ["Golem"] = 25075,
    ["Ponyta"] = 25076,
    ["Rapidash"] = 25077,
    ["Slowpoke"] = 25078,
    ["Slowbro"] = 25079,
    ["Magnemite"] = 25080,
    ["Magneton"] = 25081,
    ["Farfetchd"] = 25082,
    ["Doduo"] = 25083,
    ["Dodrio"] = 25084,
    ["Seel"] = 25085,
    ["Dewgong"] = 25086,
    ["Grimer"] = 25087,
    ["Muk"] = 25088,
    ["Shellder"] = 25089,
    ["Cloyster"] = 25090,
    ["Gastly"] = 25091,
    ["Haunter"] = 25092,
    ["Gengar"] = 25093,
    ["Onix"] = 25094,
    ["Drowzee"] = 25095,
    ["Hypno"] = 25096,
    ["Krabby"] = 25097,
    ["Kingler"] = 25098,
    ["Voltorb"] = 25099,
    ["Electrode"] = 25100,
    ["Exeggcute"] = 25101,
    ["Exeggutor"] = 25102,
    ["Cubone"] = 25103,
    ["Marowak"] = 25104,
    ["Hitmonlee"] = 25105,
    ["Hitmonchan"] = 25106,
    ["Lickitung"] = 25107,
    ["Koffing"] = 25108,
    ["Weezing"] = 25109,
    ["Rhyhorn"] = 25110,
    ["Rhydon"] = 25111,
    ["Chansey"] = 25112,
    ["Tangela"] = 25113,
    ["Kangaskhan"] = 25114,
    ["Horsea"] = 25115,
    ["Seadra"] = 25116,
    ["Goldeen"] = 25117,
    ["Seaking"] = 25118,
    ["Staryu"] = 25119,
    ["Starmie"] = 25120,
    ["Mr. Mime"] = 25121,
    ["Scyther"] = 25122,
    ["Jynx"] = 25123,
    ["Electabuzz"] = 25124,
    ["Magmar"] = 25125,
    ["Pinsir"] = 25126,
    ["Tauros"] = 25127,
    ["Magikarp"] = 25128,
    ["Gyarados"] = 25129,
    ["Lapras"] = 25130,
    ["Ditto"] = 25131,
    ["Eevee"] = 25132,
    ["Vaporeon"] = 25133,
    ["Jolteon"] = 25134,
    ["Flareon"] = 25135,
    ["Porygon"] = 25136,
    ["Omanyte"] = 25137,
    ["Omastar"] = 25138,
    ["Kabuto"] = 25139,
    ["Kabutops"] = 25140,
    ["Aerodactyl"] = 25141,
    ["Snorlax"] = 25142,
    ["Articuno"] = 25143,
    ["Zapdos"] = 25144,
    ["Moltres"] = 25145,
    ["Dratini"] = 25146,
    ["Dragonair"] = 25147,
    ["Dragonite"] = 25148,
    ["Mewtwo"] = 25149,
    ["Mew"] = 25150,
    ["Chikorita"] = 25151,
    ["Bayleef"] = 25152,
    ["Meganium"] = 25153,
    ["Cyndaquil"] = 25154,
    ["Quilava"] = 25155,
    ["Typhlosion"] = 25156,
    ["Totodile"] = 25157,
    ["Croconaw"] = 25158,
    ["Feraligatr"] = 25159,
    ["Sentret"] = 25160,
    ["Furret"] = 25161,
    ["Hoothoot"] = 25162,
    ["Noctowl"] = 25163,
    ["Ledyba"] = 25164,
    ["Ledian"] = 25165,
    ["Spinarak"] = 25166,
    ["Ariados"] = 25167,
    ["Crobat"] = 25168,
    ["Chinchou"] = 25169,
    ["Lanturn"] = 25170,
    ["Pichu"] = 25171,
    ["Cleffa"] = 25172,
    ["Igglybuff"] = 25173,
    ["Togepi"] = 25174,
    ["Togetic"] = 25175,
    ["Natu"] = 25176,
    ["Xatu"] = 25177,
    ["Mareep"] = 25178,
    ["Flaaffy"] = 25179,
    ["Ampharos"] = 25180,
    ["Bellossom"] = 25181,
    ["Marill"] = 25182,
    ["Azumarill"] = 25183,
    ["Sudowoodo"] = 25184,
    ["Politoed"] = 25185,
    ["Hoppip"] = 25186,
    ["Skiploom"] = 25187,
    ["Jumpluff"] = 25188,
    ["Aipom"] = 25189,
    ["Sunkern"] = 25190,
    ["Sunflora"] = 25191,
    ["Yanma"] = 25192,
    ["Wooper"] = 25193,
    ["Quagsire"] = 25194,
    ["Espeon"] = 25195,
    ["Umbreon"] = 25196,
    ["Murkrow"] = 25197,
    ["Slowking"] = 25198,
    ["Misdreavus"] = 25199,
    ["Unown"] = 25200,
    ["Wobbuffet"] = 25201,
    ["Girafarig"] = 25202,
    ["Pineco"] = 25203,
    ["Forretress"] = 25204,
    ["Dunsparce"] = 25205,
    ["Gligar"] = 25206,
    ["Steelix"] = 25207,
    ["Snubbull"] = 25208,
    ["Granbull"] = 25209,
    ["Qwilfish"] = 25210,
    ["Scizor"] = 25211,
    ["Shuckle"] = 25212,
    ["Heracross"] = 25213,
    ["Sneasel"] = 25214,
    ["Teddiursa"] = 25215,
    ["Ursaring"] = 25216,
    ["Slugma"] = 25217,
    ["Magcargo"] = 25218,
    ["Swinub"] = 25219,
    ["Piloswine"] = 25220,
    ["Corsola"] = 25221,
    ["Remoraid"] = 25222,
    ["Octillery"] = 25223,
    ["Delibird"] = 25224,
    ["Mantine"] = 25225,
    ["Skarmory"] = 25226,
    ["Houndour"] = 25227,
    ["Houndoom"] = 25228,
    ["Kingdra"] = 25229,
    ["Phanpy"] = 25230,
    ["Donphan"] = 25231,
    ["Porygon2"] = 25232,
    ["Stantler"] = 25233,
    ["Smeargle"] = 25234,
    ["Tyrogue"] = 25235,
    ["Hitmontop"] = 25236,
    ["Smoochum"] = 25237,
    ["Elekid"] = 25238,
    ["Magby"] = 25239,
    ["Miltank"] = 25240,
    ["Blissey"] = 25241,
    ["Raikou"] = 25242,
    ["Entei"] = 25243,
    ["Suicune"] = 25244,
    ["Larvitar"] = 25245,
    ["Pupitar"] = 25246,
    ["Tyranitar"] = 25247,
    ["Lugia"] = 25248,
    ["Ho-Oh"] = 25249,
    ["Celebi"] = 25250,
}

-- Vars

-- Methods Local
local function getPlayerDollStatus(cid, pokemonName)
    return getCreatureStorage(cid, DOLL_STORAGE_BY_POKEMON_NAME[pokemonName])
end

local function setPlayerDollStatus(cid, pokemonName, own)
    local status = own and DOLL_STATUS_OWN or -1
    doCreatureSetStorage(cid, DOLL_STORAGE_BY_POKEMON_NAME[pokemonName], status)
    doPlayerSendDollCaseUpdate(cid, getPokemonNumberByName(pokemonName), status)

    if (own) then
        setPlayerTotalCasedDolls(cid, getPlayerTotalCasedDolls(cid) + 1)
    end
end

local function doSendAlbumStatus(cid)
    local status = {}
    for _, pokemonName in pairs(pokemonNamesWithoutShiny) do
        if (DOLL_ITEMID_BY_POKEMON_NAME[pokemonName]) then
            table.insert(status, getPlayerDollStatus(cid, pokemonName))
        end
    end
    doPlayerSendDollCaseStatus(cid, status)

    doPlayerSendTextMessage(cid, MESSAGE_EVENT_ORANGE, string.format(__L(cid, "Doll case status: [%s/%s]."), getPlayerTotalCasedDolls(cid), DOLLS_NUMBER))
end

-- Methods Global
DollCase.onUse = function(cid, item, fromPosition, itemEx, toPosition)
    if (itemEx.uid == cid) then
        doSendAlbumStatus(cid)
        return true
    end

    if (not isItem(itemEx) or not POKEMON_NAME_BY_DOLL_ITEMID[itemEx.itemid]) then
        doPlayerSendDefaultCancel(cid, RETURNVALUE_NOTPOSSIBLE)
        return true

    elseif (fromPosition.x ~= CONTAINER_POSITION or toPosition.x ~= CONTAINER_POSITION) then -- TODO: This doesnt mean that the player is carring the item or no
        doPlayerSendCancel(cid, "You must pick up this item first.")
        return true
    end

    local pokemonName = POKEMON_NAME_BY_DOLL_ITEMID[itemEx.itemid]
    if (getPlayerDollStatus(cid, POKEMON_NAME_BY_DOLL_ITEMID[itemEx.itemid]) == DOLL_STATUS_OWN) then
        doPlayerSendCancel(cid, "Your album already have this doll.")
        return true
    end

    setPlayerDollStatus(cid, pokemonName, true)
    doPlayerSendTextMessage(cid, MESSAGE_STATUS_CONSOLE_BLUE, string.format(__L(cid, "Your doll case now have the %s doll!"), pokemonName))
    doSendMagicEffect(getCreaturePosition(cid), EFFECT_FIREWORK_YELLOW)
    doRemoveItem(itemEx.uid, 1)
    return true
end

DollCase.getPokemonNameByDollItemId = function(itemId)
    return POKEMON_NAME_BY_DOLL_ITEMID[itemId]
end